on: [push, pull_request]

jobs:
  fonduer-tutorials:
    runs-on: ubuntu-latest
    name: A job to run all notebooks
    steps:
    - uses: actions/checkout@v2
    - name: Build a Docker image
      uses: docker/build-push-action@v1
      with:
        repository: hiromuhota/fonduer-tutorials
        tags: latest
        push: false
    - name: Start a docker
      run: docker run -d --name fonduer-tutorials hiromuhota/fonduer-tutorials
    - name: Run a command inside a container
      run: |
        docker exec -i fonduer-tutorials /bin/bash -<<EOF
          # Convert ipynb to py
          find . -name "*.ipynb" -not -path '*/\.*' | xargs jupyter nbconvert --to script
          sed -i -e "s/get_ipython().run_line_magic('matplotlib', 'inline')/import matplotlib\nmatplotlib.use('Agg')/" */*.py
          sed -i -e 's/n_epochs=[0-9]*/n_epochs=5/g' */*.py
          sed -i -e 's/"n_epochs": [0-9]*/"n_epochs": 5/g' */*.py

          createdb stg_temp_max
          cd /home/user/hardware
          ./download_data.sh
          ipython max_storage_temp_tutorial.py

          createdb stg_temp_max_figure
          cd /home/user/wiki
          ./download_data.sh
          ipython president_place_of_birth_tutorial.py

          cd /home/user/hardware_image
          ./download_data.sh
          ipython transistor_image_tutorial.py

          createdb intro_candidates
          createdb intro_data_model
          createdb intro_supervision
          cd /home/user/intro
          ./download_data.sh
          ipython Intro_Candidates.py
          ipython Intro_Data_Model.py
          ipython Intro_Supervision.py
        EOF
